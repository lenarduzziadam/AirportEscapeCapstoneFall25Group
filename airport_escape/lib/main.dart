// Flutter app entry point and theme setup
import 'package:airport_escape/l10n/app_localizations.dart';

import 'settings/theme_toggle.dart';
import 'package:flutter/material.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:firebase_database/firebase_database.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_auth/firebase_auth.dart'; // added
import 'firebase_options.dart'; // generated by flutterfire configure
import 'landing_page.dart';
import 'package:provider/provider.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'settings/locale_provider.dart';

// Notification imports
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'dart:async';
import 'package:timezone/data/latest_all.dart' as tz;
import 'package:timezone/timezone.dart' as tz;

import 'package:airport_escape/notification_test_page.dart';

// Import RTDB test page (dev only, not active by default)
import 'database_test_page.dart';

// App-wide color constants
const kPrimaryColor = Color.fromARGB(255, 18, 71, 156);
const kBackgroundColor = Color(0xFFE0F7FA);

// Simple NotificationService helper used during app startup
class NotificationService {
  static final FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin =
      FlutterLocalNotificationsPlugin();

  static Future<void> initialize() async {
    // initialize timezone data (safe to call multiple times)
    tz.initializeTimeZones();

    const AndroidInitializationSettings androidInit =
        AndroidInitializationSettings('@mipmap/ic_launcher');

    const InitializationSettings initSettings =
        InitializationSettings(android: androidInit);

    await flutterLocalNotificationsPlugin.initialize(initSettings);

    // Create an Android notification channel used by the app
    const AndroidNotificationChannel channel = AndroidNotificationChannel(
      "high_importance_channel",
      "High Importance Notifications",
      description: "Used for important notifications.",
      importance: Importance.high,
    );

    await flutterLocalNotificationsPlugin
        .resolvePlatformSpecificImplementation<
            AndroidFlutterLocalNotificationsPlugin>()
        ?.createNotificationChannel(channel);
  }
}

// FCM background handler
Future<void> _firebaseMessagingBackgroundHandler(RemoteMessage message) async {
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  // (Optional) You can also show a local notification here
  print('Background message received: ${message.messageId}');
}


// Main function: initializes Firebase and loads tne .env file then launches the app
Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  try {
    await dotenv.load(fileName: ".env");
  } catch (e) {
    debugPrint("No .env file found, skipping dotenv load");
  }

  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);

  await NotificationService.initialize();

  // Register the FCM background handler
  FirebaseMessaging.onBackgroundMessage(_firebaseMessagingBackgroundHandler);

  // -------------------------------
  // ðŸ”” LOCAL NOTIFICATIONS SETUP
  // -------------------------------
  final FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin =
      FlutterLocalNotificationsPlugin();

  const AndroidInitializationSettings androidInit =
      AndroidInitializationSettings('@mipmap/ic_launcher');

  const InitializationSettings initSettings =
      InitializationSettings(android: androidInit);

  await flutterLocalNotificationsPlugin.initialize(initSettings);

  // Create Notification Channel for Android
  const AndroidNotificationChannel channel = AndroidNotificationChannel(
    "high_importance_channel",
    "High Importance Notifications",
    description: "Used for important notifications.",
    importance: Importance.high,
  );

  await flutterLocalNotificationsPlugin
      .resolvePlatformSpecificImplementation<
          AndroidFlutterLocalNotificationsPlugin>()
      ?.createNotificationChannel(channel);

  // -------------------------------
  // ðŸ“¡ FCM PERMISSIONS (Android/Web)
  // -------------------------------
  final messaging = FirebaseMessaging.instance;

  NotificationSettings settings = await messaging.requestPermission(
    alert: true,
    badge: true,
    sound: true,
  );

  print("FCM Permission: ${settings.authorizationStatus}");

  // Get FCM token (print it for testing)
  final token = await messaging.getToken();
  print("FCM Token: $token");

  // Handle FCM foreground messages
  FirebaseMessaging.onMessage.listen((RemoteMessage msg) {
    print("FCM Foreground: ${msg.notification?.title}");

    flutterLocalNotificationsPlugin.show(
      msg.hashCode,
      msg.notification?.title,
      msg.notification?.body,
      const NotificationDetails(
        android: AndroidNotificationDetails(
          "high_importance_channel",
          "High Importance Notifications",
          importance: Importance.high,
        ),
      ),
    );
  });

  runApp(
    MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => ThemeProvider()),
        ChangeNotifierProvider(create: (_) => LocaleProvider()),
      ],
      child: const MyApp(),
    ),
  );
}

// Root widget: sets up MaterialApp and theme
class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return Consumer<ThemeProvider>(
      builder: (context, themeProvider, child) {
        final locale = context.watch<LocaleProvider>().locale;
        return MaterialApp(
          debugShowCheckedModeBanner: false,
          title: 'Airport Escape, for passengers by passengers',
          theme: ThemeData(
            primaryColor: kPrimaryColor,
            scaffoldBackgroundColor: kBackgroundColor,
            appBarTheme: const AppBarTheme(
              backgroundColor: kPrimaryColor,
              foregroundColor: Colors.white,
            ),
          ),
          darkTheme: ThemeData.dark(),
          themeMode: themeProvider.themeMode, // line that enables darkmode!
          locale: locale,
          localizationsDelegates: const [
            AppLocalizations.delegate,
            GlobalMaterialLocalizations.delegate,
            GlobalWidgetsLocalizations.delegate,
            GlobalCupertinoLocalizations.delegate,
          ],
          supportedLocales: AppLocalizations.supportedLocales,
          routes: {
            '/notification-test': (context) => const NotificationTestPage(),
          },


          home: const _AuthGate(), // added
        );
      },
    );
  }
}

// auth gate: waits for login, then checks roles/<uid>/isAdmin
class _AuthGate extends StatelessWidget {
  const _AuthGate({super.key});

  @override
  Widget build(BuildContext context) {
    return StreamBuilder<User?>(
      stream: FirebaseAuth.instance.authStateChanges(),
      builder: (context, snap) {
        if (snap.connectionState == ConnectionState.waiting) {
          return const Scaffold(
            body: Center(child: CircularProgressIndicator()),
          );
        }
        final user = snap.data;
        if (user == null) return const _LoginPage(); // minimal login below

        // fetch roles/<uid>/isAdmin once
        return FutureBuilder<DataSnapshot>(
          future: FirebaseDatabase.instance
              .ref('roles/${user.uid}/isAdmin')
              .get(),
          builder: (context, roleSnap) {
            if (roleSnap.connectionState == ConnectionState.waiting) {
              return const Scaffold(
                body: Center(child: CircularProgressIndicator()),
              );
            }
            final isAdmin = (roleSnap.data?.value == true);
            // ignore: avoid_print
            print('isAdmin for ${user.uid}: $isAdmin'); // minimal log

            // wrap existing home and add admin-only test button
            return _Shell(isAdmin: isAdmin); // added
          },
        );
      },
    );
  }
}

// minimal email/password login
class _LoginPage extends StatefulWidget {
  const _LoginPage({super.key});
  @override
  State<_LoginPage> createState() => _LoginPageState();
}

class _LoginPageState extends State<_LoginPage> {
  final _email = TextEditingController();
  final _pw = TextEditingController();
  bool _busy = false;
  String? _error;
  bool _isSignIn = true; // toggle between sign in and register

  Future<void> _signIn() async {
    setState(() {
      _busy = true;
      _error = null;
    });
    try {
      await FirebaseAuth.instance.signInWithEmailAndPassword(
        email: _email.text.trim(),
        password: _pw.text.trim(),
      );
    } on FirebaseAuthException catch (e) {
      setState(() => _error = e.message);
    } finally {
      if (mounted) setState(() => _busy = false);
    }
  }

  Future<void> _register() async {
    setState(() {
      _busy = true;
      _error = null;
    });
    try {
      await FirebaseAuth.instance.createUserWithEmailAndPassword(
        email: _email.text.trim(),
        password: _pw.text.trim(),
      );
      // make admin via RTDB roles if needed
    } on FirebaseAuthException catch (e) {
      setState(() => _error = e.message);
    } finally {
      if (mounted) setState(() => _busy = false);
    }
  }

  @override
  void dispose() {
    _email.dispose();
    _pw.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final localizations = AppLocalizations.of(context)!;
    return Scaffold(
      appBar: AppBar(
        title: Text(_isSignIn ? localizations.signIn : localizations.register),
        elevation: 0,
        centerTitle: true,
      ),
      body: Center(
        child: SingleChildScrollView(
          child: Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              crossAxisAlignment: CrossAxisAlignment.stretch,
              children: [
                TextField(
                  controller: _email,
                  keyboardType: TextInputType.emailAddress,
                  decoration: InputDecoration(
                    labelText: AppLocalizations.of(context)!.email,
                  ),
                ),
                const SizedBox(height: 8),
                TextField(
                  controller: _pw,
                  decoration: InputDecoration(
                    labelText: AppLocalizations.of(context)!.password,
                  ),
                  obscureText: true,
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    ElevatedButton(
                      onPressed: _busy ? null : _signIn,
                      child: Text(AppLocalizations.of(context)!.signIn),
                    ),
                    const SizedBox(width: 12),
                    OutlinedButton(
                      onPressed: _busy ? null : _register,
                      child: Text(AppLocalizations.of(context)!.register),
                    ),
                  ],
                ),
                Align(
                  alignment: Alignment.centerLeft,
                  child: TextButton(
                    onPressed: _busy
                        ? null
                        : () {
                            Navigator.push(
                              context,
                              MaterialPageRoute(
                                builder: (context) =>
                                    const _ForgotPasswordPage(),
                              ),
                            );
                          },
                    child: const Text('Forgot password?'),
                  ),
                ),
                if (_error != null) ...[
                  const SizedBox(height: 12),
                  Text(_error!, style: const TextStyle(color: Colors.red)),
                ],
                if (_busy) ...[
                  const SizedBox(height: 12),
                  const LinearProgressIndicator(),
                ],
              ],
            ),
          ),

        ),
      ),
    );
  }
}

// simple password reset page
class _ForgotPasswordPage extends StatefulWidget {
  const _ForgotPasswordPage({super.key});

  @override
  State<_ForgotPasswordPage> createState() => _ForgotPasswordPageState();
}

class _ForgotPasswordPageState extends State<_ForgotPasswordPage> {
  final TextEditingController _emailController = TextEditingController();
  bool _isSending = false;
  String? _errorMessage;
  String? _successMessage;

  Future<void> _sendResetEmail() async {
    // close keyboard
    FocusScope.of(context).unfocus();

    final String email = _emailController.text.trim();

    setState(() {
      _errorMessage = null;
      _successMessage = null;
    });

    if (email.isEmpty) {
      setState(() {
        _errorMessage = 'Please enter your email.';
      });
      return;
    }

    setState(() {
      _isSending = true;
    });

    try {
      await FirebaseAuth.instance.sendPasswordResetEmail(email: email);

      setState(() {
        _successMessage =
            'Password reset email sent. Check your inbox (and spam).';
      });
    } on FirebaseAuthException catch (e) {
      String msg = 'Something went wrong. Please try again.';

      if (e.code == 'invalid-email') {
        msg = 'That email address is not valid.';
      } else if (e.code == 'user-not-found') {
        msg = 'No user found with that email.';
      }

      setState(() {
        _errorMessage = msg;
      });
    } catch (_) {
      setState(() {
        _errorMessage = 'Unexpected error. Please try again.';
      });
    } finally {
      if (mounted) {
        setState(() {
          _isSending = false;
        });
      }
    }
  }

  @override
  void dispose() {
    _emailController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Reset password')),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            const Text(
              'Enter the email you used for your account. '
              'We will send you a link to reset your password.',
            ),
            const SizedBox(height: 16),
            TextField(
              controller: _emailController,
              keyboardType: TextInputType.emailAddress,
              decoration: const InputDecoration(
                labelText: 'Email',
                border: OutlineInputBorder(),
              ),
            ),
            const SizedBox(height: 16),
            ElevatedButton(
              onPressed: _isSending ? null : _sendResetEmail,
              child: _isSending
                  ? const SizedBox(
                      height: 18,
                      width: 18,
                      child: CircularProgressIndicator(strokeWidth: 2),
                    )
                  : const Text('Send reset link'),
            ),
            const SizedBox(height: 16),
            if (_errorMessage != null)
              Text(_errorMessage!, style: const TextStyle(color: Colors.red)),
            if (_successMessage != null)
              Text(
                _successMessage!,
                style: const TextStyle(color: Colors.green),
              ),
          ],
        ),
      ),
    );
  }
}

// wraps existing home and adds an admin-only test button
class _Shell extends StatelessWidget {
  final bool isAdmin;
  const _Shell({super.key, required this.isAdmin});

  Future<void> _saveAnnouncement() async {
    final u = FirebaseAuth.instance.currentUser;
    final ref = FirebaseDatabase.instance.ref('content/announcements');
    await ref.update({
      'text': 'Hello from Airport Escape!',
      'updatedAt': DateTime.now().millisecondsSinceEpoch,
      'updatedBy': u?.uid,
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: const MyHomePage(), // your existing home untouched
      floatingActionButton: isAdmin
          ? FloatingActionButton(
              onPressed: _saveAnnouncement,
              child: const Icon(Icons.save),
            )
          : null, // no button for non-admins
    );
  }
}

// Top-level helper to schedule a local notification
Future<void> scheduleLocalNotification({
  required int seconds,
  required String title,
  required String body,
}) async {
  final flutterLocalNotificationsPlugin = FlutterLocalNotificationsPlugin();

  final scheduledDate = tz.TZDateTime.from(
    DateTime.now().add(Duration(seconds: seconds)),
    tz.local,
  );

  await flutterLocalNotificationsPlugin.zonedSchedule(
  DateTime.now().millisecondsSinceEpoch ~/ 1000, // unique ID
  title,
  body,
  scheduledDate,
  const NotificationDetails(
    android: AndroidNotificationDetails(
      "high_importance_channel",
      "High Importance Notifications",
      importance: Importance.high,
    ),
  ),
  androidScheduleMode: AndroidScheduleMode.exactAllowWhileIdle,
  matchDateTimeComponents: null, // optional
);
}
